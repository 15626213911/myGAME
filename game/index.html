<!DOCTYPE html>
<head>
         <meta charset="UTF-8" />
         <title>exam1</title>
		 <script src="phaser.js"></script>
		 <style type="text/css">
		 	#wrapper{
		 		position: relative;
		 		margin: 20px auto;
		 		width: 640px;
		 		color: #fff;
		 	}
		 	.menu-board{
		 		position: absolute;
		 		margin-left: -90px;
		 		top: 75%;
		 		left: 50%;
		 		width: 180px;
		 		font-size: 12px;
		 	}
		 	.menu-board .start-btn{
		 		margin: 0 auto;
		 		width: 180px;
		 		height: 30px;
		 		border: none;
		 		color: #fff;
		 		background: #000;
		 	}
		 	.menu-board .start-btn:hover{
		 		background: #777;		 		
		 		cursor: pointer;
		 	}
		 	.menu-board .author{
		 		margin-left: -200px;
		 		margin-top: 20px;
		 	}
		 	.select-board{
		 		position: absolute;
		 		visibility: hidden;
		 	}
		 	.dead-board{
		 		position: absolute;
		 		margin-left: -150px;
		 		padding: 20px;
		 		top: 20%;
		 		left: 50%;
		 		width: 300px;
		 		height: 200px;
		 		box-sizing: border-box;
		 		visibility: hidden;
		 	}
		 	.dead-board .board-title{
		 		text-align: center;
		 		font-size: 18px;
		 		font-weight: bold;
		 		color: #ff0000;
		 	}
		 	.dead-board .board-score{
		 		text-align: center;
		 		font-size: 12px;
		 	}
		 	.dead-board .btn{
		 		margin: 0 auto;
		 		display: block;
		 		margin-bottom: 10px;
		 		width: 180px;
		 		height: 25px;
		 		border: none;
		 		background: #777;
		 		color: #fff;
		 		text-align: center;
		 	}
		 	.dead-board .btn:hover{
		 		background: #cdcdcd;
		 		color: #000;
		 		cursor: pointer;
		 	}
		 	.info-board {
		 		position: absolute;
		 		left: 5%;
		 		top:2%;
		 		visibility: hidden;
		 		font-size: 12px;
		 	}
		 </style>
</head>
<body>
<div id="wrapper">
	<div class="menu-board">
		<button class="start-btn">START</button>
		<p class="author">Author: TanWei</p>
	</div>
	<div class="select-board">
		<p class="choie-text">MAKE A CHOICE!</p>
		<button class="choice-btn">NORMAL</button>
		<button class="choice-btn">MASTER</button>
		<button class="choice-btn">GOD</button>
	</div>
	<div class="dead-board">
		<h1 class="board-title">WASTED</h1>
		<p class="board-score">YOUR SCORE</p>
		<button class="board-btn1 btn">RESTART</button>
		<button class="board-btn2 btn">MENU</button>
	</div>
	<div class="info-board">
		<span>SCORE:</span><span class="score"></span>
		<div>
			<span>BREATH:</span>
			<span class="breath"></span>
		</div>
	</div>
</div>
<script>
 
var game = new Phaser.Game(640,320, Phaser.AUTO, 'wrapper');
var bootState = {
	preload: function(){
		game.load.image('loading','asset/pic/loading.gif')
	},
	create: function(){
		game.state.start('load'); 
	}
}

var loadState = {
	init: function(){
		this.loading = game.add.image(game.world.centerX,game.world.centerY,'loading');
		this.loading.anchor = {x:0.5,y:0.5};
		this.loading.width = 200;
		this.loading.height = 150;
		this.progressText = game.add.text(game.world.centerX,game.world.centerY+30,'0%',{fill:"#fff",fontSize:"14px"});
		this.progressText.anchor = {x:0.5,y:0.5};
	},
	preload: function(){
	    game.load.tilemap('round1','asset/round14.json',null,Phaser.Tilemap.TILED_JSON);
	    game.load.image('tiles','asset/pic/tiles.png');
	    game.load.audio('bgm','asset/bgm.wav');
	    game.load.spritesheet('ball','asset/pic/ball3.png',16,16);
	    game.load.spritesheet('man', 'asset/pic/man2.png', 20, 28);
	    game.load.spritesheet('ghost','asset/pic/ghost.png',16,16);
	    game.load.spritesheet('whelp','asset/pic/whelp.png',32,32);
	    game.load.spritesheet('snake','asset/pic/snake.png',16,16);	
	    game.load.spritesheet('ghostSword','asset/pic/ghostSword.png',24,16);	
		game.load.onFileComplete.add(function(progress){
			loadState.progressText.text = progress + '%';
		})
	},
	create: function(){
		game.state.start('menu'); 
	}
}

var menuState = {
	create: function(){
		this.menu = document.getElementsByClassName('menu-board')[0];
		this.startBtn = document.getElementsByClassName('start-btn')[0];
		this.startBtn.addEventListener('click',function(){
			menuState.menu.style.display = 'none';
			game.state.start('main');
		});
	}
}

var mainState = {
	createPlayer: function(){
	    //Sprite主角
	 	this.player = game.add.sprite(120, 120, 'man');
	 	game.physics.enable(this.player, Phaser.Physics.ARCADE); 
	 	//Sprite-body
	    this.player.body.bounce.y = 0.2;
	    // this.player.body.collideWorldBounds = true;
	    this.player.body.setSize(20, 28, 0, 0);
	    //Sprite-animations
	    this.player.animations.add('right', [1,2,3,4], 10, true);	
	    // this.player.animations.add('left', [0, 1, 2, 3], 10, true);	
	    this.player.jumpTimer = 0;	
	},
	createEnemy: function(){
		this.enemy = game.add.group();
		this.enemySnake = game.add.group(this.enemy);
	    //Sprite敌人 
	 	this.enemy_whelp = this.createWhelp(7200,48);
	 	this.enemy_ghost = this.createGhost(5760,144);
	 	this.enemy_ghostSword1 = this.createGhostSword(1744,224);
	 	this.enemy_ghostSword2 = this.createGhostSword(2224,224);
	 	this.enemy_ghostSword3 = this.createGhostSword(2608,48);
	 	this.enemy_ghostSword4 = this.createGhostSword(3776,224);
	 	this.enemy_ghostSword5 = this.createGhostSword(4368,224);
	 	this.enemy_ghostSword6 = this.createGhostSword(5280,224);
	 	this.enemy_ghostSword7 = this.createGhostSword(5408,224);
	 	this.enemy_ghostSword8 = this.createGhostSword(5760,224);

	 	this.ghostSword = [this.enemy_ghostSword1,this.enemy_ghostSword2,this.enemy_ghostSword3,this.enemy_ghostSword4,this.enemy_ghostSword5,this.enemy_ghostSword6,this.enemy_ghostSword7,this.enemy_ghostSword8];

	 	this.enemy_snake1 = this.createSnake(576,224);
	 	this.enemy_snake2 = this.createSnake(768,224);
	 	this.enemy_snake3 = this.createSnake(1120,224);
	 	this.enemy_snake4 = this.createSnake(1600,16);
	 	this.enemy_snake5 = this.createSnake(4192,160);
	 	this.enemy_snake6 = this.createSnake(4752,112);
	 	this.enemy_snake7 = this.createSnake(4912,176);
	 	this.enemy_snake8 = this.createSnake(6496,96);

 		this.enemy_snake4.exists = false;
	},	
	createSnake: function(x,y){
		var snake;
		snake = game.add.sprite(x,y,'snake','',this.enemySnake);
		game.physics.enable(snake, Phaser.Physics.ARCADE);
		snake.animations.add('left', [0,1], 6, true);
		return snake;
	},
	createGhost: function(x,y){
		var ghost;
		ghost = game.add.sprite(x,y,'ghost','',this.enemy);
		game.physics.enable(ghost, Phaser.Physics.ARCADE);
		ghost.animations.add('left', [0,1], 6, true);
		return ghost;
	},
	createGhostSword: function(x,y){
		var ghostSword;
		ghostSword = game.add.sprite(x,y,'ghostSword','',this.enemy);
		game.physics.enable(ghostSword, Phaser.Physics.ARCADE);
		ghostSword.animations.add('left', [0,1], 6, true);
		ghostSword.animations.add('right', [2,3], 6, true);
		return ghostSword;
	},
	createWhelp: function(x,y){
		var whelp;
		whelp = game.add.sprite(x,y,'whelp','',this.enemy);
		game.physics.enable(whelp, Phaser.Physics.ARCADE);
		whelp.body.gravity = 0;
		whelp.animations.add('right', [ 1,2,3], 6, true);
		return whelp;
	},
	createBall: function(){
		this.ball1 = this.createFireBall(2896,64);
		this.ball2 = this.createFireBall(2976,64);
		this.ball3 = this.createFireBall(3056,64);
		this.ball4 = this.createFireBall(3088,64);
		this.ball5 = this.createFireBall(3360,128);
		this.ball6 = this.createFireBall(3392,128);
		this.ball7 = this.createFireBall(3504,128);
		this.ball8 = this.createFireBall(3536,128);
		this.ball9 = this.createFireBall(3616,128);
		this.ball10 = this.createFireBall(3648,128);
		this.ball11 = this.createFireBall(3680,128);
		this.ball12 = this.createFireBall(3856,128);
		this.ball13 = this.createFireBall(3888,128);
		this.ball14 = this.createFireBall(4560,48);
		this.ball15 = this.createFireBall(5632,64);
		this.ball16 = this.createFireBall(5792,64);

		this.ball1.exists = false;
		this.ball2.exists = false;
		this.ball3.exists = false;
		this.ball4.exists = false;
		this.ball5.exists = false;
		this.ball6.exists = false;
		this.ball7.exists = false;
		this.ball8.exists = false;
		this.ball9.exists = false;
		this.ball10.exists = false;
		this.ball11.exists = false;
		this.ball12.exists = false;
		this.ball13.exists = false;
		this.ball14.exists = false;
		this.ball15.exists = false;
		this.ball16.exists = false;
	},
	createFireBall: function(x,y){
		var ball;
		ball = game.add.emitter(x,y,20);
		ball.makeParticles('ball',[0,1,2],10,true,false);
		ball.setXSpeed(0);
		ball.setYSpeed(10);
		ball.setRotation(0);
		// ball.bounce.setTo(0.5, 0.5);
		ball.start(false,1000,900,50);
		return ball;
	},
	preload: function(){
	},
	create: function(){
		if(this.bgm){
		this.bgm.stop();			
		}

		this.board = document.getElementsByClassName('dead-board')[0];
		this.board.style.visibility = 'hidden';

	    //Tilemap创建地图
	    this.map = game.add.tilemap('round1');
	    this.map.addTilesetImage('tiles');
	    this.layer = this.map.createLayer('world');
	    this.layer.resizeWorld();

	    //Tilemap设置碰撞检测
	    this.map.setCollision([3,4,5,6,7,8,9,11,12,14,15,18,19,20,23,24,30,35,38,41,42,45,50,51,52,53,56,57,60,61,63,64,65,66,67,68,69,70,76,78,79,80,81,82,83,84,85,95,96,97,98,99,100,115,116,118,120,121,123,125,127,133,135,136,137,139,140,141,142,143,144,145,146,147,148,150,151,152,154,155,156,157,158,163,165]);
		//Physics全局物理系统
	    game.physics.startSystem(Phaser.Physics.ARCADE);
		game.physics.arcade.gravity.y = 800; 

		this.createBall();
	    this.createPlayer();
	    this.createEnemy();  

	    this.bgm = game.add.audio('bgm');
	    this.bgm.play();
	    this.info = document.getElementsByClassName('info-board')[0];
	    this.info.style.visibility = 'visible';
	    this.scoreBoard = this.info.getElementsByClassName('score')[0];
	    this.breathBoard = this.info.getElementsByClassName('breath')[0];
	    this.score = 0;
	    this.scoreTimer = setInterval(function(){
	    	mainState.score++;
	    	mainState.scoreBoard.innerHTML = mainState.score;
	    	console.log(mainState.score);
	    },1000);
	    this.breath = 100;
	    this.breathTimer = setInterval(function(){
	    	if(mainState.breath <100){
	    		mainState.breath++;		    		
	    	}
	    	mainState.breathBoard.innerHTML = mainState.breath;
	    },1000)
	    //Input操控
	    this.cursors = game.input.keyboard.createCursorKeys();
	    this.spaceButton = game.input.keyboard.addKey(Phaser.KeyCode.Z);	
	    this.jumpButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);	
	    this.jumpButton.onDown.add(this.jump);
	    this.spaceButton.onDown.add(this.pause);

	    this.restartBtn = document.getElementsByClassName('board-btn1')[0];
	    this.menuBtn = document.getElementsByClassName('board-btn2')[0];

	    this.restartBtn.addEventListener('click',function(){game.state.start('main');});
	    // this.menuBtn.addEventListener('click',function(){game.state.start('menu');});
	},
	update: function(){
		game.physics.arcade.collide(this.player, this.layer);
		game.physics.arcade.collide(this.enemy,this.layer);
		game.physics.arcade.collide(this.enemySnake,this.layer);

		this.enemy.enableBody = true;
		if(this.player.x > 1350){
			this.enemy_snake4.exists = true;
			console.log('this.enemy_snake4.exists = true;');
		}
		if(this.player.x > 2400){
			this.ball1.exists = true;
			this.ball2.exists = true;
			this.ball3.exists = true;
			this.ball4.exists = true;
			this.ball5.exists = true;
			this.ball6.exists = true;
			this.ball7.exists = true;
		}
		if(this.player.x >3000){
			this.ball8.exists = true;
			this.ball9.exists = true;
			this.ball10.exists = true;
			this.ball11.exists = true;
			this.ball12.exists = true;
			this.ball13.exists = true;
		}
		if(this.player.x > 3800){
			this.ball14.exists = true;
			this.ball15.exists = true;
			this.ball16.exists = true;
		}
		if(this.cursors.left.isDown){
			this.player.body.velocity.x = -60;
		}else if(this.cursors.right.isDown){
			this.player.body.velocity.x = 130;			
		}else{
			this.player.body.velocity.x  = 0;
		}

		if (!this.player.alive || !this.player.inCamera ) {
			this.player.alive = false;
			game.camera.shake(0.002,500);
			mainState.player.body.velocity.x = 0;
			clearInterval(this.scoreTimer);
			clearInterval(this.breathTimer);
			this.showScoreBoard();

		}else{
			game.physics.arcade.overlap(this.player, this.enemy, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.enemySnake, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.trap, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball1, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball2, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball3, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball4, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball5, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball6, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball7, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball8, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball9, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball10, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball11, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball12, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball13, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball14, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball15, this.die, null, this);
			game.physics.arcade.overlap(this.player, this.ball16, this.die, null, this);

			game.camera.x += 2;
			// game.camera.follow(this.player);
			this.player.animations.play('right');

			// this.enemy_whelp.body.velocity.x = -10;

			this.enemy_snake1.body.velocity.x = -80;
			this.enemy_snake2.body.velocity.x = -80;
			this.enemy_snake3.body.velocity.x = -80;
			this.enemy_snake4.body.velocity.x = -80;
			this.enemy_snake5.body.velocity.x = -80;
			this.enemy_snake6.body.velocity.x = -80;
			this.enemy_snake7.body.velocity.x = -80;
			this.enemy_snake8.body.velocity.x = -80;


			this.enemy_ghost.animations.play('left');

			this.enemy_snake1.animations.play('left');
			this.enemy_snake2.animations.play('left');
			this.enemy_snake3.animations.play('left');
			this.enemy_snake4.animations.play('left');
			this.enemy_snake5.animations.play('left');
			this.enemy_snake6.animations.play('left');

			for (var i = 0; i < this.ghostSword.length; i++) {
				if(game.physics.arcade.distanceBetween(this.player,this.ghostSword[i]) <640){
					game.physics.arcade.accelerateToObject(this.ghostSword[i],this.player,100);
				}
				if (this.player.x > this.ghostSword[i].x) {
					this.ghostSword[i].animations.play('right');
				}else{
					this.ghostSword[i].animations.play('left');
				}
			}
			if (game.physics.arcade.distanceBetween(this.player,this.enemy_whelp) < 640) {
				game.physics.arcade.accelerateToObject(this.enemy_whelp,this.player,100,100,80);
				console.log('accelerateToObject(this.enemy_whelp,this.player,100)');
				this.enemy_whelp.animations.play('right');
			}
		}
	},
	die: function(){
		this.player.alive = false;	

	},
	jump: function(){
		if(!mainState.player.body.onFloor()){
			if(mainState.breath < 50){
				// mainState.player.body.velocity.y = -250;
			}else{
				mainState.player.body.velocity.y = -250;
				mainState.breath -= 50;
			}
		}else{
			mainState.player.body.velocity.y = -250;
		}
	},
	pause: function(){
		if (mainState.player.alive) {
			game.paused  = !game.paused;			
		}
	},
	showScoreBoard: function(){
		var scoreBoard = document.getElementsByClassName('board-score')[0];
		scoreBoard.innerHTML = 'YOUR SCORE:' + mainState.score;
		this.board.style.visibility = 'visible';
		this.jumpButton.onDown.add(this.restart);
	},
	restart: function(){
		if (!mainState.player.alive) {
			game.state.start('main'); 			
		}
	}
}

function pause(){
	game.pause();
}
game.state.add('boot', bootState);  
game.state.add('load', loadState);  
game.state.add('menu', menuState);  
game.state.add('main', mainState);  
game.state.start('boot'); 

</script>
 
</body>
